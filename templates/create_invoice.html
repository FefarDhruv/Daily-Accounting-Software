{% extends "base.html" %}
{% block title %}Create Invoice{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Create Invoice</h2>
    <form method="POST" action="{{ url_for('create_invoice') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <!-- Customer Select -->
        <div class="form-group">
            <label for="customer_id">Select Customer</label>
            <select class="form-control" id="customer_id" name="customer_id" required>
                {% for customer in customers %}
                <option value="{{ customer.id }}">{{ customer.customer_name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Invoice Date -->
        <div class="form-group">
            <label for="invoice_date">Invoice Date</label>
            <input type="date" class="form-control" id="invoice_date" name="invoice_date" required>
        </div>

        <!-- Line Items Section -->
        <div id="line-items-section">
            <h5>Line Items</h5>
            <div class="line-item row mb-3">
                <!-- Product Dropdown -->
                <div class="form-group col-md-4">
                    <label for="product_id">Product</label>
                    <select class="form-control" name="product_id[]" required>
                        <option value="">-- Select Product --</option>
                        {% for product in products %}
                        <option value="{{ product.id }}">{{ product.product_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Quantity Field -->
                <div class="form-group col-md-3">
                    <label for="quantity">Quantity</label>
                    <input type="number" class="form-control quantity" name="quantity[]" placeholder="Quantity" min="1" required>
                </div>
                <!-- Unit Price Field -->
                <div class="form-group col-md-3">
                    <label for="unit_price">Unit Price</label>
                    <input type="number" class="form-control unit-price" name="unit_price[]" placeholder="Unit Price" step="0.01" required>
                </div>
                <!-- Remove Button -->
                <div class="form-group col-md-2">
                    <button type="button" class="btn btn-danger remove-item">Remove</button>
                </div>
            </div>
        </div>

        <!-- Button to Add More Items -->
        <button type="button" class="btn btn-primary" id="add-item-btn">Add Item</button>

        <!-- Total Amount -->
        <div class="form-group mt-4">
            <label for="total_amount">Total Amount</label>
            <input type="number" class="form-control" id="total_amount" name="total_amount" step="0.01" required readonly>
        </div>

        <!-- Status -->
        <div class="form-group">
            <label for="status">Status</label>
            <select class="form-control" id="status" name="status" required>
                <option value="Draft">Draft</option>
                <option value="Final">Final</option>
            </select>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="btn btn-dark">Create Invoice</button>
    </form>
</div>

<!-- JavaScript to handle dynamic line items and total calculation -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Function to calculate total amount
    function calculateTotal() {
        var total = 0;
        var lineItems = document.querySelectorAll('.line-item');
        lineItems.forEach(function(item) {
            var quantity = item.querySelector('input[name="quantity[]"]').value;
            var unitPrice = item.querySelector('input[name="unit_price[]"]').value;
            if (quantity && unitPrice) {
                total += parseFloat(quantity) * parseFloat(unitPrice);
            }
        });
        document.getElementById('total_amount').value = total.toFixed(2);
    }

    // Add event listeners to dynamically update total on quantity and price change
    function addEventListenersToLineItem(item) {
        item.querySelector('input[name="quantity[]"]').addEventListener('input', calculateTotal);
        item.querySelector('input[name="unit_price[]"]').addEventListener('input', calculateTotal);
        item.querySelector('.remove-item').addEventListener('click', function() {
            item.remove();
            calculateTotal();
        });
    }

    // Initial line item event listeners
    var initialLineItem = document.querySelector('.line-item');
    addEventListenersToLineItem(initialLineItem);

    // Add new line item
    document.getElementById('add-item-btn').addEventListener('click', function() {
        var lineItemsSection = document.getElementById('line-items-section');
        var newItem = initialLineItem.cloneNode(true);
        newItem.querySelectorAll('input').forEach(function(input) {
            input.value = '';
        });
        lineItemsSection.appendChild(newItem);
        addEventListenersToLineItem(newItem);
    });
});
</script>
{% endblock %}
