{% extends "base.html" %}

{% block title %}Create Bill{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Create Bill</h2>
    <form action="{{ url_for('create_bill') }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="form-group">
            <label for="bill_number">Bill Number:</label>
            <input type="text" class="form-control" id="bill_number" name="bill_number" value="{% if bill %}{{ bill.bill_number }}{% endif %}" required>
        </div>
        <div class="form-group">
            <label for="purchase_order_id">Select Purchase Order:</label>
            <select class="form-control" id="purchase_order_id" name="purchase_order_id" onchange="loadPurchaseOrderItems()" required>
                <option value="">-- Select Purchase Order --</option>
                {% for order in purchase_orders %}
                <option value="{{ order.id }}" {% if bill and bill.purchase_order_id == order.id %}selected{% endif %}>
                    {{ order.id }} - {{ order.vendor.vendor_name }} ({{ order.total_amount }})
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="bill_date">Bill Date:</label>
            <input type="date" class="form-control" id="bill_date" name="bill_date" value="{% if bill %}{{ bill.bill_date.strftime('%Y-%m-%d') }}{% endif %}" required>
        </div>

        <!-- Line Items Table -->
        <div class="form-group">
            <label>Line Items:</label>
            <table class="table table-bordered" id="lineItemsTable">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="lineItemsBody">
                    {% for item in purchase_order_line_items %}
                    <tr>
                        <td><input type="text" class="form-control" name="item_name[]" value="{{ item.item_name }}" required></td>
                        <td><input type="number" class="form-control" name="quantity[]" value="{{ item.quantity }}" onchange="calculateTotalAmount()" required></td>
                        <td><input type="number" step="0.01" class="form-control" name="unit_price[]" value="{{ item.unit_price }}" onchange="calculateTotalAmount()" required></td>
                        <td class="line-item-total">{{ item.quantity * item.unit_price }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Total Amount Display -->
        <div class="form-group">
            <label for="total_amount">Total Amount:</label>
            <input type="text" class="form-control" id="total_amount" name="total_amount" value="{% if bill %}{{ bill.total_amount }}{% endif %}" readonly>
        </div>

        <div class="form-group">
            <label for="status">Status:</label>
            <select class="form-control" id="status" name="status" required>
                <option value="Pending" {% if bill and bill.status == 'Pending' %}selected{% endif %}>Pending</option>
                <option value="Completed" {% if bill and bill.status == 'Completed' %}selected{% endif %}>Completed</option>
                <option value="Cancelled" {% if bill and bill.status == 'Cancelled' %}selected{% endif %}>Cancelled</option>
            </select>
        </div>

        <button type="submit" class="btn btn-primary">Create Bill</button>
    </form>
</div>

<script>
    function loadPurchaseOrderItems() {
        // Clear existing line items
        document.getElementById('lineItemsBody').innerHTML = '';

        // Get the selected purchase order ID
        var purchaseOrderId = document.getElementById('purchase_order_id').value;

        // Fetch the line items for the selected purchase order using AJAX (fetch API)
        if (purchaseOrderId) {
            fetch(`/get_purchase_order_items/${purchaseOrderId}`)
                .then(response => response.json())
                .then(data => {
                    let lineItems = data.line_items;
                    let lineItemsBody = document.getElementById('lineItemsBody');

                    // Populate the table with line items
                    let totalAmount = 0;
                    lineItems.forEach(item => {
                        let row = `<tr>
                            <td><input type="text" class="form-control" name="item_name[]" value="${item.item_name}" required></td>
                            <td><input type="number" class="form-control" name="quantity[]" value="${item.quantity}" onchange="calculateTotalAmount()" required></td>
                            <td><input type="number" step="0.01" class="form-control" name="unit_price[]" value="${item.unit_price}" onchange="calculateTotalAmount()" required></td>
                            <td class="line-item-total">${item.quantity * item.unit_price}</td>
                        </tr>`;
                        lineItemsBody.innerHTML += row;
                        totalAmount += item.quantity * item.unit_price;
                    });

                    // Set the total amount
                    document.getElementById('total_amount').value = totalAmount.toFixed(2);
                });
        }
    }

    function calculateTotalAmount() {
        let totalAmount = 0;
        const lineItemsBody = document.getElementById('lineItemsBody');
        const rows = lineItemsBody.getElementsByTagName('tr');

        // Loop through each row to calculate total amount
        for (let i = 0; i < rows.length; i++) {
            const quantity = parseFloat(rows[i].querySelector('input[name="quantity[]"]').value) || 0;
            const unitPrice = parseFloat(rows[i].querySelector('input[name="unit_price[]"]').value) || 0;
            const lineTotal = quantity * unitPrice;

            // Set the line total in the last column
            rows[i].querySelector('.line-item-total').textContent = lineTotal.toFixed(2);

            // Accumulate the total amount
            totalAmount += lineTotal;
        }

        // Update the total amount in the form
        document.getElementById('total_amount').value = totalAmount.toFixed(2);
    }

    // Call the function to calculate total amount on page load
    window.onload = function () {
        calculateTotalAmount();
    }
</script>
{% endblock %}
